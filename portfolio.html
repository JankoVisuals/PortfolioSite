<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio • Reels</title>
  <style>
    :root{
      --bg0:#05050b;
      --bg1:#0b0615;
      --fg:#eae7ff;
      --muted:#a6a0c2;
      --accent:#A855F7;
      --accent-2:#c084fc;
      --ring: rgba(168,85,247,.38);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--fg);
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(168,85,247,0.85) 0%, transparent 55%),
        radial-gradient(1000px 600px at 90% 120%, #1c0b3d 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }

    .wrapper{
      min-height:100%;
      padding:min(4vmin,48px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
    }

    .stage{
      position:relative;
      width:min(1600px, 94vw);
      height:min(86vh, 860px);
      margin:0 auto;
      background:
        radial-gradient(120% 200% at 50% -40%, rgba(168,85,247,.25), transparent 60%),
        rgba(10,5,24,0.96);
      border-radius:28px;
      padding:min(2.4vmin,28px);
      box-shadow:0 20px 80px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
    }

    .belt{
      position:relative;
      width:100%;
      height:100%;
      perspective:1600px;
    }

    .card{
      position:absolute;
      top:50%;
      left:50%;
      width:min(22vw, 320px);
      aspect-ratio:9/16;
      transform:translate(-50%,-50%);
      transform-style:preserve-3d;
      border-radius:20px;
      overflow:hidden;
      background:#05040a;
      box-shadow:0 24px 60px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.04) inset;
      transition:
        transform .5s cubic-bezier(.2,.8,.2,1),
        filter .35s ease,
        opacity .35s ease;
      will-change:transform;
      cursor:pointer;
    }
    .card video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
      transition:filter .25s ease;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:20px;
      pointer-events:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
    }

    .card.is-center{
      filter:drop-shadow(0 22px 64px rgba(168,85,247,.5));
    }

    .nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:56px;
      height:56px;
      display:grid;
      place-items:center;
      border-radius:999px;
      border:1px solid var(--ring);
      color:#fff;
      cursor:pointer;
      user-select:none;
      background:rgba(17,8,38,.75);
      backdrop-filter:blur(6px);
      transition:background .2s ease, transform .2s ease, box-shadow .2s ease;
      box-shadow:0 0 0 1px rgba(0,0,0,.7), 0 10px 25px rgba(0,0,0,.7);
    }
    .nav:hover{
      background:rgba(33,12,72,.85);
      box-shadow:0 0 0 1px rgba(168,85,247,.6), 0 12px 30px rgba(0,0,0,.85);
    }
    .nav:active{
      transform:translateY(-50%) scale(.97);
      box-shadow:0 4px 12px rgba(0,0,0,.9);
    }
    .nav--prev{left:12px;}
    .nav--next{right:12px;}
    .nav svg{width:22px;height:22px;}

    .counter{
      position:absolute;
      bottom:14px;
      left:50%;
      transform:translateX(-50%);
      font-size:.9rem;
      color:var(--muted);
      background:rgba(5,3,18,.9);
      padding:.35rem .9rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 8px 20px rgba(0,0,0,.7);
      backdrop-filter:blur(4px);
    }

    .contact-cta{
      display:flex;
      justify-content:center;
      width:100%;
    }
    .contact-cta a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.75rem 1.5rem;
      border-radius:16px;
      color:#fff;
      text-decoration:none;
      font-weight:700;
      letter-spacing:.2px;
      background:#0b031b;
      border:1px solid rgba(168,85,247,.95);
      box-shadow:
        0 0 0 1px rgba(168,85,247,.6),
        0 0 32px rgba(168,85,247,.45);
      min-width:130px;
      text-align:center;
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .contact-cta a:hover{
      transform:translateY(-1px);
      background:#13052a;
      box-shadow:
        0 0 0 1px rgba(168,85,247,1),
        0 0 40px rgba(168,85,247,.7);
    }
    .contact-cta a:active{
      transform:translateY(1px) scale(.98);
      box-shadow:
        0 0 0 1px rgba(168,85,247,.9),
        0 0 24px rgba(168,85,247,.5);
    }

    /* Fullscreen overlay */
    .fs-overlay{
      position:fixed;
      inset:0;
      background:
        radial-gradient(120% 200% at 50% -40%, rgba(168,85,247,.35), transparent 60%),
        rgba(1,1,12,.97);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .fs-overlay.is-open{
      display:flex;
    }
    .fs-inner{
      position:relative;
      width:min(100vw, 560px);
      max-height:100vh;
      padding:20px;
    }
    .fs-inner video{
      width:100%;
      height:auto;
      max-height:calc(100vh - 80px);
      border-radius:24px;
      background:#000;
      box-shadow:0 30px 80px rgba(0,0,0,.95);
    }
    .fs-close{
      position:absolute;
      top:18px;
      right:24px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      background:rgba(11,3,29,.98);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size:18px;
      line-height:1;
      box-shadow:0 0 0 1px rgba(168,85,247,.9);
    }
    .fs-close:hover{
      background:rgba(22,7,60,1);
    }

    /* mobile tweaks */
    @media (max-width:820px){
      .stage{height:calc(100vh - 150px);}
      .card{width:min(60vw, 320px);}
      .nav{width:48px;height:48px;}
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <section class="stage" aria-label="Reels karusel">
      <div class="belt" id="belt" role="listbox" aria-live="polite"></div>
      <button class="nav nav--prev" id="btnPrev" aria-label="Prethodni reel" title="Prethodni (←)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <button class="nav nav--next" id="btnNext" aria-label="Sledeći reel" title="Sledeći (→)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <div class="counter" id="counter" aria-live="polite" aria-atomic="true">Učitavanje…</div>
    </section>

    <div class="contact-cta">
      <a href="kontakt.html" aria-label="Otvori kontakt stranicu">Kontakt</a>
    </div>
  </div>

  <!-- Fullscreen overlay -->
  <div class="fs-overlay" id="fsOverlay" aria-hidden="true">
    <div class="fs-inner">
      <button class="fs-close" id="fsClose" aria-label="Zatvori video">×</button>
      <video id="fsVideo" playsinline controls></video>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // ==== CONFIG ====
    const VIDEO_BASE = "https://mlvbvuwdxasdbguczsmb.supabase.co/storage/v1/object/public/videos/"; // promeni po potrebi
    const PROBE_MAX = 50;   // proverava 1..PROBE_MAX
    const VISIBLE_SPAN = 4; // koliko karata levo/desno ima punu transformaciju

    const belt = document.getElementById("belt");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const counter = document.getElementById("counter");

    const fsOverlay = document.getElementById("fsOverlay");
    const fsVideo = document.getElementById("fsVideo");
    const fsClose = document.getElementById("fsClose");

    /** @type {{idx:number, src:string, el:HTMLElement, video:HTMLVideoElement}[]} */
    let items = [];
    let center = 0;
    let userInteracted = false;

    // ==== helpers ====
    function createCard(src, idx){
      const card = document.createElement("figure");
      card.className = "card";
      card.setAttribute("role","option");
      card.setAttribute("aria-label","Reel #" + idx);
      card.dataset.index = String(idx);

      const v = document.createElement("video");
      v.className = "reel";
      v.playsInline = true;
      v.preload = "metadata";
      v.muted = true;     // u pozadini tihi
      v.loop = true;
      v.crossOrigin = "anonymous";
      v.src = src;

      card.appendChild(v);

      card.addEventListener("click", () => {
        userInteracted = true;
        const myIndex = items.findIndex(it => it.el === card);
        if (myIndex === center){
          openFs(items[center]);
        } else {
          center = myIndex;
          layout();
          playCenter();
        }
      });

      return { idx, src, el: card, video: v };
    }

    function normDelta(i){
      const n = items.length;
      let d = (i - center) % n;
      if (d < -n/2) d += n;
      if (d > n/2) d -= n;
      return d;   // negativno levo, pozitivno desno
    }

    function layout(){
      if (!items.length) return;
      const stage = belt.getBoundingClientRect();
      const cardW = Math.min(stage.width * 0.22, 320);
      const gap = cardW * 0.70;
      const depth = VISIBLE_SPAN + 1;

      items.forEach((it, i) => {
        const d = normDelta(i);
        const abs = Math.abs(d);
        const clamped = Math.max(-VISIBLE_SPAN, Math.min(VISIBLE_SPAN, d));

        const x = clamped * gap;
        const z = 80 - Math.abs(clamped)*80;
        const rotZ = clamped * 8;
        const rotY = clamped * -12;
        const scale = 1 - Math.min(abs*0.06, 0.35);

        it.el.style.transform =
          `translate(-50%,-50%) translateX(${x}px) translateZ(${z}px) rotateZ(${rotZ}deg) rotateY(${rotY}deg) scale(${scale})`;

        // svi ostaju neprozirni, samo se zatamnjuju
        it.el.style.opacity = "1";
        if (it.video){
          const dim = 1 - Math.min(abs*0.25, 0.85); // veći abs -> tamnije
          it.video.style.filter = `brightness(${0.45 + dim*0.55})`;
        }

        // sloj – desna strana blago iznad leve
        const depthIndex = Math.min(abs, depth);
        const zIndex = (depth - depthIndex) * 10 + (d > 0 ? 1 : 0);
        it.el.style.zIndex = String(zIndex);

        if (d === 0){
          it.el.classList.add("is-center");
          it.el.setAttribute("aria-selected","true");
        } else {
          it.el.classList.remove("is-center");
          it.el.removeAttribute("aria-selected");
        }
      });

      counter.textContent = (center+1) + " / " + items.length;
    }

    function playCenter(){
      if (!items.length) return;
      items.forEach((it, i) => {
        const vid = it.video;
        if (i === center){
          try{
            vid.currentTime = 0;
            vid.muted = !userInteracted; // dok nema interakcije – mute
            const p = vid.play();
            if (p && typeof p.then === "function"){
              p.catch(()=>{ /* autoplay policy */ });
            }
          }catch(e){}
        } else {
          try{
            vid.pause();
            vid.muted = true;
          }catch(e){}
        }
      });
    }

    function next(){
      center = (center + 1) % items.length;
      layout();
      playCenter();
    }
    function prev(){
      center = (center - 1 + items.length) % items.length;
      layout();
      playCenter();
    }

    // ==== fullscreen overlay ====
    function openFs(item){
      if (!fsOverlay || !fsVideo) return;
      try{ item.video.pause(); }catch(e){}
      const src = item.video.currentSrc || item.video.src;
      fsVideo.src = src;
      fsVideo.currentTime = 0;
      fsVideo.muted = false;
      fsOverlay.classList.add("is-open");
      fsOverlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      try{ fsVideo.play().catch(()=>{}); }catch(e){}
    }

    function closeFs(){
      if (!fsOverlay || !fsVideo) return;
      fsOverlay.classList.remove("is-open");
      fsOverlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      try{ fsVideo.pause(); }catch(e){}
      fsVideo.removeAttribute("src");
      // vrati se na centar u normalnom modu
      playCenter();
    }

    if (fsClose){
      fsClose.addEventListener("click", closeFs);
    }
    if (fsOverlay){
      fsOverlay.addEventListener("click", (e) => {
        if (e.target === fsOverlay) closeFs();
      });
    }
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && fsOverlay && fsOverlay.classList.contains("is-open")){
        closeFs();
      }
    });

    // ==== kontrole ====
    btnNext.addEventListener("click", () => { userInteracted = true; next(); });
    btnPrev.addEventListener("click", () => { userInteracted = true; prev(); });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight"){ userInteracted = true; next(); }
      else if (e.key === "ArrowLeft"){ userInteracted = true; prev(); }
    });

    // swipe
    let dragX = null;
    belt.addEventListener("pointerdown", (e) => {
      dragX = e.clientX;
      userInteracted = true;
    });
    window.addEventListener("pointerup", (e) => {
      if (dragX == null) return;
      const dx = e.clientX - dragX;
      dragX = null;
      const TH = 40;
      if (dx > TH) prev();
      else if (dx < -TH) next();
    });

    window.addEventListener("resize", () => layout());

    // ==== učitavanje videa 1..PROBE_MAX (preskače nepostojeće) ====
    async function probeOne(i){
      const src = VIDEO_BASE + i + ".mp4";
      return new Promise(resolve => {
        const v = document.createElement("video");
        v.preload = "metadata";
        v.muted = true;
        v.playsInline = true;
        v.crossOrigin = "anonymous";

        const doneOk = () => { cleanup(); resolve({ ok:true, src }); };
        const doneBad = () => { cleanup(); resolve({ ok:false, src }); };

        function cleanup(){
          v.removeEventListener("loadedmetadata", doneOk);
          v.removeEventListener("error", doneBad);
        }

        v.addEventListener("loadedmetadata", doneOk, { once:true });
        v.addEventListener("error", doneBad, { once:true });

        v.src = src + "#t=0.1";
      });
    }

    (async function init(){
      const probes = [];
      for (let i=1;i<=PROBE_MAX;i++){
        probes.push(probeOne(i));
      }
      const results = await Promise.all(probes);
      const found = results.filter(r => r.ok);

      if (!found.length){
        counter.textContent = "Nema dostupnih videa.";
        return;
      }

      found.forEach((r, idx) => {
        const item = createCard(r.src, idx+1);
        belt.appendChild(item.el);
        items.push(item);
      });

      layout();

      // pokušaj da pokrene sve muted, da se buffferuju
      items.forEach(it => {
        try{ it.video.play().then(()=>{ it.video.pause(); }).catch(()=>{}); }catch(e){}
      });

      playCenter();
    })();

  })();
  </script>
</body>
</html>
